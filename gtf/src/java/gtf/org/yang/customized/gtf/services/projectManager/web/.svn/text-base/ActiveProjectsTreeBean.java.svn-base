/* Generated by Together */

package org.yang.customized.gtf.services.projectManager.web;
import java.util.Properties;
import java.util.Collection;
import java.util.Iterator;

import org.yang.web.applicationContainer.SecuredBean;
import org.yang.web.applicationContainer.Passport;

import org.yang.services.accountmgr.Group;
import org.yang.services.accountmgr.User;
import org.yang.services.accountmgr.UserManager;
import org.yang.web.view.controls.jsStyle.navigationTree.NavigationTree;
import org.yang.services.accountmgr.AccountDataAccessException;
import org.yang.services.servicemgr.Area;
import java.util.Map;
import org.yang.customized.gtf.services.dataAccess.Project;
import org.yang.customized.gtf.services.projectManager.ProjectManager;
import org.yang.customized.gtf.services.dataAccess.Stage;
import org.yang.web.view.controls.jsStyle.panel.GenericPanel;
import org.yang.web.view.controls.jsStyle.panel.TabPanelElement;

public class ActiveProjectsTreeBean extends ProjectsBean
{
   static final long serialVersionUID = 4711296382979764905L;

   private static int OPEN_NODE = 0;
   private static int CLOSE_NODE = 1;

   private int event = 0;
   public int getEvent() { return event; }

   private String targetID = null;
   public void setTargetID(String targetID) { this.targetID = targetID; }
   public String getTargetID() { return targetID; }

   private String targetType = null;
   public void setTargetType(String targetType) { this.targetType = targetType; }
   public String getTargetType() { return targetType; }

   public ActiveProjectsTreeBean()
   {
      super();
   }

   /*************************************
    *  Implement NavigationTree method  *
    *************************************/

   public String getDomain()
   {
      return passport.getDomain();
   }

   public String[] getAllAvailableProjectTypes()
   {
      return passport.getServiceAreas("ProjectManager");
   }

   public Project[] getAllAvailableProjects()
   {
       try
       {
          String cDomain = null;
          if(!gotPermit("ProjectManager", targetType, ProjectManager.CROSS_DOMAIN))
             cDomain = getDomain();
          String cGroup = null;
          //if(!gotPermit("ProjectManager", targetType, ProjectManager.CROSS_GROUP))
          //   cGroup = getGroup();
          String cUser = null;
          if(!gotPermit("ProjectManager", targetType, ProjectManager.CROSS_USER))
             cUser = passport.getUsername();

          String condition = null;
          if(gotPermit("ProjectManager", targetType, ProjectManager.HISTORY))
             condition = "name LIKE '*%'";
          else
             condition = "name NOT LIKE '*%'";

          // combination
          // 1. xuser  , xdomain  : getProjects(type, null, null, null, condition)   -> assistant
          // 2. xuser  , ~xdomain : getProjects(type, domain, null, null, condition) -> lab manager
          // 3. ~xuser , xdomain  : getProjects(type, null, null, user, condition)   -> xdomain user
          // 4. ~xuser , ~xdomain : getProjects(type, domain, null, user, condition) -> normal user
          return projectMgr.getProjects(targetType, cDomain, cGroup, cUser, condition);
       }
       catch(Exception e)
       {
          e.printStackTrace();
       }

       return new Project[0];
   }

   public Stage[] getAllAvailableStagesUnderProject(String projectId)
   {
      try
      {
         return projectMgr.getStages(projectId);
      }
      catch(Exception e)
      {
         e.printStackTrace();
      }

      return new Stage[0];
   }

   public Stage[] getAllAvailableStages()
   {
      return projectMgr.getAllAvailableStages(targetType);
   }

   public Project[] getAllAvailableProjectsHaveStage(String stageName)
   {
      try
      {
         if(gotPermit("ProjectManager", targetType, ProjectManager.CROSS_DOMAIN))
            return projectMgr.getProjectsByStageName(targetType, stageName, null);
         else
            return projectMgr.getProjectsByStageName(targetType, stageName, getDomain());
      }
      catch(Exception e)
      {
         e.printStackTrace();
      }

      return new Project[0];
   }

   /***************************************
    *  Implement GenericHandler's method  *
    ***************************************/

   protected void init() throws Exception
   {
      ensureResource();

      String[] areas = passport.getServiceAreas("ProjectManager");
      if(null!=areas&&0<areas.length)
      {
         targetType = areas[0];
      }

      if(null==projectMgr)
         throw new Exception("Project manager is null.");
   }

   protected String altPage()
   {
      if(isReload)
      {
         return "reload-forward";
      }
      else
         return null;
   }

   /***************************************
    *           my action method          *
    ***************************************/
   public void load()
   {
      this.removeControl("projectsTreePanel");
   }

   protected void destroy()
   {
      projectMgr = null;
   }

   public void changeType()
   {
      passport.setRuntimeProperty("projectType", targetType);
      targetID = null;
      isReload = true;
   }

   public void open()
   {
      NavigationTree tree = (NavigationTree)((TabPanelElement)((GenericPanel)this.getControl("projectsTreePanel")).getSubcontrol(targetType)).getSubcontrol("projectsTree");
      tree.openNode(targetID);
   }

   public void close()
   {
      NavigationTree tree = (NavigationTree)((TabPanelElement)((GenericPanel)this.getControl("projectsTreePanel")).getSubcontrol(targetType)).getSubcontrol("projectsTree");
      tree.closeNode(targetID);
   }
}